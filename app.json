[{"name":"app.R","content":"library(shiny)\r\nlibrary(DT)\r\n\r\n# Define UI\r\nui <- fluidPage(\r\n  titlePanel(\"Double Taxation Elimination Calculator\"),\r\n  \r\n  sidebarLayout(\r\n    sidebarPanel(\r\n      h4(\"Revenue\"),\r\n      numericInput(\"rev_a\", \"Revenue Country A:\", value = 500),\r\n      numericInput(\"rev_b\", \"Revenue Country B:\", value = 200),\r\n      numericInput(\"rev_c\", \"Revenue Country C:\", value = 300),\r\n      \r\n      h4(\"Costs\"),\r\n      numericInput(\"cost_a\", \"Costs related to Income Country A:\", value = 300),\r\n      numericInput(\"cost_b\", \"Costs related to Income Country B:\", value = 50),\r\n      numericInput(\"cost_c\", \"Costs related to Income Country C:\", value = 200),\r\n      numericInput(\"overhead\", \"Overhead (OH) Costs:\", value = 100),\r\n      \r\n      h4(\"Tax Rates (%)\"),\r\n      numericInput(\"tax_rate_a\", \"Tax rate Country A (net profits):\", value = 40, step = 1),\r\n      numericInput(\"tax_rate_b\", \"Tax rate Country B (withholding):\", value = 10, step = 1),\r\n      numericInput(\"tax_rate_c\", \"Tax rate Country C (withholding):\", value = 15, step = 1)\r\n    ),\r\n    \r\n    mainPanel(\r\n      # Box for Intermediary Calculations\r\n      wellPanel(\r\n        h4(\"Intermediary Calculations\"),\r\n        tableOutput(\"interTable\")\r\n      ),\r\n      \r\n      h4(\"Cross-crediting Calculation Results\"),\r\n      DTOutput(\"resultsTable\")\r\n    )\r\n  )\r\n)\r\n\r\n# Define Server logic\r\nserver <- function(input, output) {\r\n  \r\n  # Helper to convert percentage inputs to decimals for math\r\n  get_rates <- reactive({\r\n    list(\r\n      a = input$tax_rate_a / 100,\r\n      b = input$tax_rate_b / 100,\r\n      c = input$tax_rate_c / 100\r\n    )\r\n  })\r\n  \r\n  # Intermediary Calculations (For the top box)\r\n  inter_calc <- reactive({\r\n    rates <- get_rates()\r\n    \r\n    tot_rev <- input$rev_a + input$rev_b + input$rev_c\r\n    tot_cost <- input$cost_a + input$cost_b + input$cost_c + input$overhead\r\n    tot_profit <- tot_rev - tot_cost\r\n    \r\n    tax_paid_b <- input$rev_b * rates$b\r\n    tax_paid_c <- input$rev_c * rates$c\r\n    tot_foreign_tax <- tax_paid_b + tax_paid_c\r\n    \r\n    data.frame(\r\n      Metric = c(\"Total Income (Revenue)\", \r\n                 \"Total Costs (Including Overhead)\", \r\n                 \"Total Global Profit\", \r\n                 \"Tax Paid in Country B\", \r\n                 \"Tax Paid in Country C\", \r\n                 \"Total Foreign Tax Paid\"),\r\n      Value = c(tot_rev, \r\n                tot_cost, \r\n                tot_profit, \r\n                tax_paid_b, \r\n                tax_paid_c, \r\n                tot_foreign_tax)\r\n    )\r\n  })\r\n  \r\n  # Render the Intermediary Table cleanly\r\n  output$interTable <- renderTable({\r\n    inter_calc()\r\n  }, colnames = FALSE, align = 'lr')\r\n  \r\n  \r\n  # 1. Raw Data Calculation for Scenarios\r\n  calc_data <- reactive({\r\n    rates <- get_rates()\r\n    \r\n    tot_rev <- input$rev_a + input$rev_b + input$rev_c\r\n    tot_cost <- input$cost_a + input$cost_b + input$cost_c + input$overhead\r\n    tot_profit <- tot_rev - tot_cost\r\n    \r\n    tax_paid_b <- input$rev_b * rates$b\r\n    tax_paid_c <- input$rev_c * rates$c\r\n    tot_foreign_tax <- tax_paid_b + tax_paid_c\r\n    \r\n    tax_a_base <- tot_profit * rates$a\r\n    \r\n    oh_a <- input$overhead * (input$rev_a / tot_rev)\r\n    oh_b <- input$overhead * (input$rev_b / tot_rev)\r\n    oh_c <- input$overhead * (input$rev_c / tot_rev)\r\n    \r\n    prof_b_dir <- input$rev_b - input$cost_b\r\n    prof_c_dir <- input$rev_c - input$cost_c\r\n    prof_b_full <- prof_b_dir - oh_b\r\n    prof_c_full <- prof_c_dir - oh_c\r\n    \r\n    # S1: No relief\r\n    s1_tax_a <- tax_a_base\r\n    s1_tot_tax <- s1_tax_a + tot_foreign_tax\r\n    s1_rate <- s1_tot_tax / tot_profit\r\n    s1_abs <- 0\r\n    \r\n    # S2: Deduction\r\n    s2_taxable <- tot_profit - tot_foreign_tax\r\n    s2_tax_a <- s2_taxable * rates$a\r\n    s2_tot_tax <- s2_tax_a + tot_foreign_tax\r\n    s2_rate <- s2_tot_tax / tot_profit\r\n    s2_abs <- (s1_tax_a - s2_tax_a) / tot_foreign_tax\r\n    \r\n    # S3: Exemption, overhead home\r\n    s3_taxable <- input$rev_a - input$cost_a - input$overhead\r\n    s3_tax_a <- s3_taxable * rates$a\r\n    s3_tot_tax <- s3_tax_a + tot_foreign_tax\r\n    s3_rate <- s3_tot_tax / tot_profit\r\n    s3_abs <- 0\r\n    \r\n    # S4: Exemption, overhead attributed by revenue\r\n    s4_taxable <- input$rev_a - input$cost_a - oh_a\r\n    s4_tax_a <- s4_taxable * rates$a\r\n    s4_tot_tax <- s4_tax_a + tot_foreign_tax\r\n    s4_rate <- s4_tot_tax / tot_profit\r\n    s4_abs <- 0\r\n    \r\n    # S5: TC, cross all\r\n    s5_limit <- tot_profit * rates$a\r\n    s5_credit <- min(tot_foreign_tax, s5_limit)\r\n    s5_tax_a <- tax_a_base - s5_credit\r\n    s5_tot_tax <- s5_tax_a + tot_foreign_tax\r\n    s5_rate <- s5_tot_tax / tot_profit\r\n    s5_abs <- s5_credit / tot_foreign_tax\r\n    \r\n    # S6: TC, cross foreign, direct\r\n    s6_limit <- (prof_b_dir + prof_c_dir) * rates$a\r\n    s6_credit <- min(tot_foreign_tax, s6_limit)\r\n    s6_tax_a <- tax_a_base - s6_credit\r\n    s6_tot_tax <- s6_tax_a + tot_foreign_tax\r\n    s6_rate <- s6_tot_tax / tot_profit\r\n    s6_abs <- s6_credit / tot_foreign_tax\r\n    \r\n    # S7: TC, cross foreign, direct + overhead\r\n    s7_limit <- (prof_b_full + prof_c_full) * rates$a\r\n    s7_credit <- min(tot_foreign_tax, s7_limit)\r\n    s7_tax_a <- tax_a_base - s7_credit\r\n    s7_tot_tax <- s7_tax_a + tot_foreign_tax\r\n    s7_rate <- s7_tot_tax / tot_profit\r\n    s7_abs <- s7_credit / tot_foreign_tax\r\n    \r\n    # S8: TC, no cross, direct\r\n    s8_lim_b <- prof_b_dir * rates$a\r\n    s8_lim_c <- prof_c_dir * rates$a\r\n    s8_cred_b <- min(tax_paid_b, s8_lim_b)\r\n    s8_cred_c <- min(tax_paid_c, s8_lim_c)\r\n    s8_credit <- s8_cred_b + s8_cred_c\r\n    s8_tax_a <- tax_a_base - s8_credit\r\n    s8_tot_tax <- s8_tax_a + tot_foreign_tax\r\n    s8_rate <- s8_tot_tax / tot_profit\r\n    s8_abs <- s8_credit / tot_foreign_tax\r\n    \r\n    # S9: TC, no cross, direct + overhead\r\n    s9_lim_b <- prof_b_full * rates$a\r\n    s9_lim_c <- prof_c_full * rates$a\r\n    s9_cred_b <- min(tax_paid_b, s9_lim_b)\r\n    s9_cred_c <- min(tax_paid_c, s9_lim_c)\r\n    s9_credit <- s9_cred_b + s9_cred_c\r\n    s9_tax_a <- tax_a_base - s9_credit\r\n    s9_tot_tax <- s9_tax_a + tot_foreign_tax\r\n    s9_rate <- s9_tot_tax / tot_profit\r\n    s9_abs <- s9_credit / tot_foreign_tax\r\n    \r\n    df <- data.frame(\r\n      Metric = c(\r\n        \"Total credit limit\",\r\n        \"Credit limit country B\",\r\n        \"Credit limit country C\",\r\n        \"Tax payment Country A\",\r\n        \"Total Tax payment\",\r\n        \"Total tax rate on profit\",\r\n        \"Share of foreign tax that is absorbed\"\r\n      ),\r\n      \"No relief\" = c(NA, NA, NA, s1_tax_a, s1_tot_tax, s1_rate, s1_abs),\r\n      \"Deduction\" = c(NA, NA, NA, s2_tax_a, s2_tot_tax, s2_rate, s2_abs),\r\n      \"Exemption (OH allocated to Home)\" = c(NA, NA, NA, s3_tax_a, s3_tot_tax, s3_rate, s3_abs),\r\n      \"Exemption (OH apportioned)\" = c(NA, NA, NA, s4_tax_a, s4_tot_tax, s4_rate, s4_abs),\r\n      \"Cross-crediting (with domestic income)\" = c(s5_limit, NA, NA, s5_tax_a, s5_tot_tax, s5_rate, s5_abs),\r\n      \"Cross-crediting (Foreign only, direct cost only)\" = c(s6_limit, NA, NA, s6_tax_a, s6_tot_tax, s6_rate, s6_abs),\r\n      \"Cross-crediting (Foreign only, Direct+OH allocated)\" = c(s7_limit, NA, NA, s7_tax_a, s7_tot_tax, s7_rate, s7_abs),\r\n      \"No cross-crediting (Direct)\" = c(NA, s8_lim_b, s8_lim_c, s8_tax_a, s8_tot_tax, s8_rate, s8_abs),\r\n      \"No cross-crediting (Direct + OH)\" = c(NA, s9_lim_b, s9_lim_c, s9_tax_a, s9_tot_tax, s9_rate, s9_abs),\r\n      check.names = FALSE\r\n    )\r\n    return(df)\r\n  })\r\n  \r\n  # 2. Formatted Data Calculation (Used for UI Display)\r\n  display_data <- reactive({\r\n    df <- calc_data()\r\n    pct_rows <- which(df$Metric %in% c(\"Total tax rate on profit\", \"Share of foreign tax that is absorbed\"))\r\n    \r\n    # Loop through columns to format text, handling NAs gracefully\r\n    for(col in names(df)[-1]) {\r\n      num_vals <- df[[col]]\r\n      char_col <- character(nrow(df))\r\n      char_col[-pct_rows] <- ifelse(is.na(num_vals[-pct_rows]), \"\", format(round(num_vals[-pct_rows], 2), nsmall = 2))\r\n      char_col[pct_rows] <- ifelse(is.na(num_vals[pct_rows]), \"\", sprintf(\"%.2f%%\", num_vals[pct_rows] * 100))\r\n      df[[col]] <- char_col\r\n    }\r\n    \r\n    return(df)\r\n  })\r\n  \r\n  # Render Table\r\n  output$resultsTable <- renderDT({\r\n    datatable(display_data(), \r\n              options = list(dom = 't', paging = FALSE, scrollX = TRUE), \r\n              rownames = FALSE) %>%\r\n      formatStyle('Metric', fontWeight = 'bold')\r\n  })\r\n}\r\n\r\n# Run the app\r\nshinyApp(ui = ui, server = server)","type":"text"}]
